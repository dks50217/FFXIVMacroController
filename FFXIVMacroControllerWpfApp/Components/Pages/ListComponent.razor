@using System.Collections.ObjectModel
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime


<RadzenDataGrid @ref="ordersGrid" RowRender="@RowRender" @bind-Value="selectedMacros" ColumnWidth="150px" AllowFiltering="true" AllowSorting="true" Data="@marcoList">
    <HeaderTemplate>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10">
            <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Click="@InsertRow" />
            <RadzenButton ButtonStyle="ButtonStyle.Secondary" Icon="refresh" />
            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="cancel" />
            <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="done_all" />
            <RadzenFormField Text="重複次數" Variant="Variant.Outlined">
                <RadzenNumeric @bind-Value="@Category.repeat" Min="1" />
            </RadzenFormField>
        </RadzenStack>
    </HeaderTemplate>
    
    <Columns>
            <RadzenDataGridColumn Property="@nameof(MacroModel.keyNumber)" Title="按鍵" Sortable="false" Filterable="false" Width="180px">
                <Template Context="data">
                    <RadzenDropDown @bind-Value="data.keyNumber"
                                    AllowFiltering="true"
                                    TextProperty="@nameof(OptionModel.label)"
                                    ValueProperty="@nameof(OptionModel.value)"
                                    Data="KeyList"
                                    Style="width: 100%; max-width: 400px;" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(MacroModel.type)" Title="類型">
                <Template Context="data">
                    <RadzenDropDown @bind-Value="data.typeNumber"
                                    AllowFiltering="true"
                                    TextProperty="@nameof(OptionModel.label)"
                                    ValueProperty="@nameof(OptionModel.value)"
                                    Data="TypeList"
                                    Style="width: 100%; max-width: 400px;" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(MacroModel.sleep)" Title="執行後暫停">
                <Template Context="data">
                    <RadzenNumeric Min="1" @bind-Value="data.sleep" InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "enter value" }})" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(MacroModel.inputText)" Title="文字">
                <Template Context="data">
                    <RadzenTextBox @bind-Value="data.inputText" Style="width: 100%" aria-label="Default TextBox" />
                </Template>
            </RadzenDataGridColumn>
        <RadzenDataGridColumn Width="50px" Context="data" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="data">
                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => DeleteRow(data))" @onclick:stopPropagation="true"></RadzenButton>
            </Template>
        </RadzenDataGridColumn>
        </Columns>
</RadzenDataGrid>


@code {

    private ObservableCollection<MacroModel>? marcoList;
    private MacroModel? draggedItem;
    private IList<MacroModel>? selectedMacros;

    [Parameter]
    public CategoryModel? Category { get; set; }

    [Parameter]
    public List<OptionModel>? KeyList { get; set; }

    [Parameter]
    public List<OptionModel>? TypeList { get; set; }

    DataGridEditMode editMode = DataGridEditMode.Single;

    RadzenDataGrid<MacroModel> ordersGrid;

    protected override void OnInitialized()
    {
        if (Category != null)
        {
            marcoList = new ObservableCollection<MacroModel>(Category.macroList);

            selectedMacros = new List<MacroModel>() { marcoList.FirstOrDefault() };
        }
    }

    protected async Task InsertRow()
    {
        var marco = new MacroModel()
        {
            type = Types.button,
            key = Keys.D1,
            sleep = 3,
            keyNumber = (int)Keys.D1,
            inputText = "/echo 123"
        };

        this.marcoList?.Add(marco);
        await ordersGrid.Reload();
    }

    protected async Task DeleteRow(MacroModel macro)
    {
        this.marcoList?.Remove(macro);
        await ordersGrid.Reload();
    }

    private void RowRender(RowRenderEventArgs<MacroModel> args)
    {
        args.Attributes.Add("title", "Drag row to reorder");
        args.Attributes.Add("style", "cursor:grab");
        args.Attributes.Add("draggable", "true");
        args.Attributes.Add("ondragover", "event.preventDefault();event.target.closest('.rz-data-row').classList.add('my-class')");
        args.Attributes.Add("ondragleave", "event.target.closest('.rz-data-row').classList.remove('my-class')");
        args.Attributes.Add("ondragstart", EventCallback.Factory.Create<DragEventArgs>(this, () => draggedItem = args.Data));
        args.Attributes.Add("ondrop", EventCallback.Factory.Create<DragEventArgs>(this, () =>
        {
            var draggedIndex = marcoList.IndexOf(draggedItem);
            var droppedIndex = marcoList.IndexOf(args.Data);
            marcoList.Remove(draggedItem);
            marcoList.Insert(draggedIndex <= droppedIndex ? droppedIndex++ : droppedIndex, draggedItem);

            JSRuntime.InvokeVoidAsync("eval", $"document.querySelector('.my-class').classList.remove('my-class')");
        }));
    }
}

<style>
    .my-class td {
        border-top: 1px solid black;
        border-bottom: 1px solid black;
    }
</style>